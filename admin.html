<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== Admin-Check =====
  const isAdmin = sessionStorage.getItem("admin_mode") === "1";

  const hintEl = document.getElementById("adminHint");
  const accessStatusEl = document.getElementById("accessStatus");
  const backBtn = document.getElementById("backBtn");

  const quizTxtEl = document.getElementById("quizTxt");
  const loadBtn = document.getElementById("loadBtn");
  const saveBtn = document.getElementById("saveBtn");
  const saveStatusEl = document.getElementById("saveStatus");

  backBtn.addEventListener("click", () => {
    sessionStorage.removeItem("admin_mode");
    location.href = "./index.html";
  });

  if (!isAdmin) {
    hintEl.textContent = "Kein Zugriff";
    accessStatusEl.textContent =
      "❌ Du bist nicht im Admin-Modus. Bitte starte über das Namensfeld mit dem Code.";

    quizTxtEl.disabled = true;
    loadBtn.disabled = true;
    saveBtn.disabled = true;
    throw new Error("Not in admin_mode"); // Script hier bewusst beenden
  }

  hintEl.textContent = "Admin-Modus aktiv";
  accessStatusEl.textContent = "✅ Zugriff OK. Quiz kann bearbeitet werden.";

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
    storageBucket: "...",
    messagingSenderId: "...",
    appId: "...",
    measurementId: "..."
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const setSaveStatus = (t) => (saveStatusEl.textContent = t);

  async function loadCurrent() {
    const snap = await getDoc(doc(db, "quizzes", "current"));
    if (!snap.exists()) {
      quizTxtEl.value = "TITLE: ...\nSUB: ...\n\nQ: ...";
      setSaveStatus("Noch nichts gespeichert.");
      return;
    }
    quizTxtEl.value = snap.data().txt || "";
    setSaveStatus("Geladen ✅");
  }

  async function saveCurrent() {
    const txt = String(quizTxtEl.value || "");
    if (!txt.includes("TITLE:") || !txt.includes("Q:") || !txt.includes("CORRECT:")) {
      setSaveStatus("❌ Ungültiges Quiz-TXT.");
      return;
    }

    await setDoc(doc(db, "quizzes", "current"), {
      txt,
      updatedAt: serverTimestamp()
    }, { merge: true });

    setSaveStatus("Gespeichert ✅");
  }

  loadBtn.addEventListener("click", loadCurrent);
  saveBtn.addEventListener("click", saveCurrent);

  loadCurrent();
</script>
